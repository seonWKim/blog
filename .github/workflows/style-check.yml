name: Style Guide Compliance Check

on:
  pull_request:
    paths:
      - '_posts/**/*.md'
      - '_research/**/*.md'
      - '_pages/**/*.md'
  workflow_dispatch:

jobs:
  style-check:
    runs-on: ubuntu-latest
    name: Check Style Guide Compliance
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli
      
      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD024": {
              "siblings_only": true
            }
          }
          EOF
      
      - name: Run markdownlint on changed files
        run: |
          echo "## Markdown Linting Results" >> $GITHUB_STEP_SUMMARY
          
          # Get list of changed markdown files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '(_posts|_research|_pages)/.*\.md$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No markdown files changed in content directories." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "### Changed Files:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$CHANGED_FILES" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run markdownlint
          if echo "$CHANGED_FILES" | xargs markdownlint --config .markdownlint.json; then
            echo "‚úÖ All markdown files pass linting rules" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some markdown files have linting issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Check style guide compliance
        run: |
          echo "## Style Guide Compliance Check" >> $GITHUB_STEP_SUMMARY
          
          # Get list of changed markdown files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '(_posts|_research|_pages)/.*\.md$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            exit 0
          fi
          
          ISSUES_FOUND=0
          
          echo "### Checking for common style issues..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for file in $CHANGED_FILES; do
            if [ ! -f "$file" ]; then
              continue
            fi
            
            echo "#### $file" >> $GITHUB_STEP_SUMMARY
            FILE_ISSUES=0
            
            # Check for excessive emojis (more than one repeated)
            if grep -n "üòÆüòÆ\|üéâüéâ\|üëçüëç\|‚ù§Ô∏è‚ù§Ô∏è" "$file" > /dev/null 2>&1; then
              echo "‚ö†Ô∏è Found repeated emojis (avoid excessive emoji usage)" >> $GITHUB_STEP_SUMMARY
              grep -n "üòÆüòÆ\|üéâüéâ\|üëçüëç\|‚ù§Ô∏è‚ù§Ô∏è" "$file" | head -3 >> $GITHUB_STEP_SUMMARY || true
              FILE_ISSUES=1
            fi
            
            # Check for casual phrases that should be avoided
            if grep -ni "seems interesting\|seems cool\|pretty cool\|NUMA, NUMA, NUMA" "$file" > /dev/null 2>&1; then
              echo "‚ö†Ô∏è Found overly casual phrases (check STYLE_GUIDE.md for alternatives)" >> $GITHUB_STEP_SUMMARY
              grep -ni "seems interesting\|seems cool\|pretty cool\|NUMA, NUMA, NUMA" "$file" | head -3 >> $GITHUB_STEP_SUMMARY || true
              FILE_ISSUES=1
            fi
            
            # Check for inconsistent terminology
            if grep -n "virtual CPU\|vcpu" "$file" > /dev/null 2>&1; then
              echo "‚ö†Ô∏è Use 'vCPU' instead of 'virtual CPU' or 'vcpu' (see STYLE_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
              grep -n "virtual CPU\|vcpu" "$file" | head -3 >> $GITHUB_STEP_SUMMARY || true
              FILE_ISSUES=1
            fi
            
            # Check for IO vs I/O (excluding code blocks and commands)
            if grep -v '`' "$file" | grep -nw "IO\|io" | grep -v "I/O" > /dev/null 2>&1; then
              echo "‚ÑπÔ∏è Consider using 'I/O' for input/output (except in code)" >> $GITHUB_STEP_SUMMARY
              FILE_ISSUES=1
            fi
            
            if [ $FILE_ISSUES -eq 0 ]; then
              echo "‚úÖ No style issues detected" >> $GITHUB_STEP_SUMMARY
            else
              ISSUES_FOUND=1
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
          done
          
          if [ $ISSUES_FOUND -eq 0 ]; then
            echo "### ‚úÖ All files comply with style guide" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ö†Ô∏è Style guide suggestions found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the suggestions above and refer to [STYLE_GUIDE.md](../blob/${{ github.head_ref }}/STYLE_GUIDE.md) for detailed guidelines." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Note: These are recommendations to improve consistency. Review and apply as appropriate." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Add comment to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read the step summary
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            
            // Only comment if there are actual style issues
            if (summary.includes('‚ö†Ô∏è') || summary.includes('‚ùå')) {
              const comment = `## Style Guide Compliance Check Results\n\n${summary}\n\n---\n*This is an automated check. Please review the [Style Guide](../blob/${context.payload.pull_request.head.ref}/STYLE_GUIDE.md) for detailed guidelines.*`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
